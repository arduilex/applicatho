rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Règle pour la collection users
    // Les utilisateurs authentifiés peuvent créer et mettre à jour leur propre document
    match /users/{userId} {
      // Permettre la lecture de son propre document
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // Permettre la création de son propre document lors de l'inscription
      allow create: if request.auth != null 
                    && request.auth.uid == userId
                    && request.resource.data.keys().hasAll(['email', 'createdAt', 'emailVerified'])
                    && request.resource.data.email is string
                    && request.resource.data.emailVerified is bool;
      
      // Permettre la mise à jour de son propre document
      allow update: if request.auth != null 
                    && request.auth.uid == userId
                    && request.resource.data.email == resource.data.email; // Empêcher le changement d'email
      
      // Empêcher la suppression (ou permettre uniquement à l'admin)
      allow delete: if false;
    }
    
    // Collections publiques en lecture seule pour les utilisateurs authentifiés
    match /saints/{document=**} {
      allow read: if request.auth != null;
      allow write: if false; // Seuls les admins peuvent écrire (à configurer plus tard)
    }
    
    match /verses/{document=**} {
      allow read: if request.auth != null;
      allow write: if false;
    }
    
    match /events/{document=**} {
      allow read: if request.auth != null;
      allow write: if false;
    }
    
    match /prayers/{document=**} {
      allow read: if request.auth != null;
      allow write: if false;
    }
    
    match /churches/{document=**} {
      allow read: if request.auth != null;
      allow write: if false;
    }
    
    match /members/{document=**} {
      allow read: if request.auth != null;
      allow write: if false;
    }
    
    match /faqs/{document=**} {
      allow read: if request.auth != null;
      allow write: if false;
    }
    
    // Refuser l'accès à toutes les autres collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
